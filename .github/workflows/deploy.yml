name: ğŸš€ Deploy KRYONIX Platform

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy via webhook (Manual fallback)
        run: |
          echo "â„¹ï¸ GitHub webhook automatico ja esta configurado"
          echo "ğŸ”— Webhook URL: https://kryonix.com.br/api/github-webhook"
          echo "ğŸ¯ Este job serve como fallback manual se necessario"

          # Verificar se o webhook esta respondendo
          curl -f "https://kryonix.com.br/health" || exit 1

      - name: ğŸ—ï¸ Verify deployment
        run: |
          echo "ğŸ” Aguardando deployment automatico..."
          sleep 60

          # Verificar multiplas vezes
          for i in {1..10}; do
            if curl -f "https://kryonix.com.br/health"; then
              echo "âœ… Deployment verificado com sucesso!"
              exit 0
            fi
            echo "â³ Tentativa $i/10 - aguardando..."
            sleep 30
          done

          echo "âš ï¸ Verificacao manual necessaria"
          exit 1
